{"componentChunkName":"component---src-templates-blog-post-js","path":"/tls-mutual-authentication/","result":{"data":{"site":{"siteMetadata":{"title":"beaclnd92's Blog","author":{"name":"beaclnd92","summary":"who keeps learning and thinking"}}},"markdownRemark":{"id":"af851f67-711d-52a0-9e6b-cfa7d140408e","excerpt":"试验如何在客户端与服务端之间建立需双向身份验证的HTTPS/TLS连接。 试验工具与环境 OS：  Win10 x64: 运行Chrome ArchLinux x64: 运行OpenSSL,NodeJS客户端,NodeJS服务端 OpenSSL：1.1.1c Chrome：80.0.3987.132  NodeJS…","html":"<p>试验如何在客户端与服务端之间建立需双向身份验证的HTTPS/TLS连接。</p>\n<h2>试验工具与环境</h2>\n<ul>\n<li>\n<p>OS： </p>\n<ul>\n<li>Win10 x64: 运行Chrome</li>\n<li>ArchLinux x64: 运行OpenSSL,NodeJS客户端,NodeJS服务端</li>\n</ul>\n</li>\n<li>OpenSSL：1.1.1c</li>\n<li>Chrome：80.0.3987.132 </li>\n<li>\n<p>NodeJS：10.16.3</p>\n<h2>证书关系结构</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 331px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/3efe58dd09cb861da037a04f63507af3/62452/hierarchy-certs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 102.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/UlEQVQ4y5WUh8rrMAyF8/4vVmjp3nvvvXd1+QQybprAfw2OHVs+lo6OHIjXPp+PjrfbTabTqazXaxkMBjKfz/V/NpvJdruVyWTyc8ZaEAd4Pp91XqlUpF6vS7/fl9FopGu73c7Z/hnwcDjo/Hq9SjableFw6Ozw8r8AH4+HLBYL2e/36s14PNZwmbPGntnHAvqbjO/3W16vl6xWKwWBAri83++R9l+A/obNASQphGzt+XzqGpTEgQa26G8CslwuNfSog5vNxnHs79O/OKRdLpcf46h52M6FDMHoio5EUqmUJoD14/H446ElDD6bzaYkEgk9i6TgWwENKJPJSKFQ0DnSIBkkxvfO6CgWi5LL5VRS6XRaOw4EHLQQuBHSrSGTMCB2p9NJ54ztdls9cyFDMI2xVqtpKL6AowCNCi5vNBpK0ReHhAYQoVMRAHFBHId4hPfUd7lcVuHzz7nANEczzkzY4eyGhW+0GIaTjRlyA+KNq56o2iWSr0rxDxGiz1kcoN9Ni65S/B/ePr+s4kL2G8+a70SAIHGb3u12NTlGMFkMg6FDe2ix63Q6KnSXFIBYQKRkjAvy+bxyGSUbXh3012q1nCp6vZ4KHUkFfCzDvMy+sMOcmoeWOPirVqtixaEcUmaovVQqudJDrBhyczjbXEIEeMiZZDKp3lFlOPQPEGdWLFun3gkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"证书关系\"\n        title=\"证书关系\"\n        src=\"/blog/static/3efe58dd09cb861da037a04f63507af3/62452/hierarchy-certs.png\"\n        srcset=\"/blog/static/3efe58dd09cb861da037a04f63507af3/12f09/hierarchy-certs.png 148w,\n/blog/static/3efe58dd09cb861da037a04f63507af3/e4a3f/hierarchy-certs.png 295w,\n/blog/static/3efe58dd09cb861da037a04f63507af3/62452/hierarchy-certs.png 331w\"\n        sizes=\"(max-width: 331px) 100vw, 331px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n</li>\n<li>Root CA(RC)是自签名根证书</li>\n<li>由Root CA(RC)签发中间CA证书Intermediate CA1(IC1)与Intermediate CA2(IC2)</li>\n<li>由IC1签发客户端证书Client Cert(CC)</li>\n<li>由IC2签发服务端证书Server Cert(SC) </li>\n</ul>\n<blockquote>\n<p>Note: 使用ECC算法（secp256k1等曲线）生成的公钥证书建立HTTPS/TLS连接有问题，这里使用RSA算法生成的证书进行试验。</p>\n</blockquote>\n<ul>\n<li>\n<p>生成Root CA证书RC:</p>\n<ol>\n<li><code class=\"language-text\">openssl genrsa -out root_key.pem 2048</code></li>\n<li><code class=\"language-text\">openssl req -new -key root_key.pem -x509 -nodes -days 365 -subj &quot;/CN=TestRoot/O=RepChain&quot; -out root_cert.pem</code></li>\n</ol>\n</li>\n<li>\n<p>生成Intermediate CA1证书IC1: </p>\n<ol>\n<li><code class=\"language-text\">openssl genrsa -out ic1_key.pem 2048</code></li>\n<li><code class=\"language-text\">openssl req -new -key ic1_key.pem -nodes -subj &quot;/CN=TestIntermediate1/O=RepChain&quot; -out ic1_csr.pem</code></li>\n<li><code class=\"language-text\">echo basicConstraints=CA:TRUE &gt; ca_v3.ext</code></li>\n<li><code class=\"language-text\">openssl x509 -req -extfile ca_v3.ext -days 365 -set_serial 01 -in ic1_csr.pem -CA root_cert.pem -CAkey root_key.pem -out ic1_cert.pem</code></li>\n</ol>\n</li>\n<li>\n<p>生成Intermediate CA2证书IC2: </p>\n<ol>\n<li><code class=\"language-text\">openssl genrsa -out ic2_key.pem 2048</code></li>\n<li><code class=\"language-text\">openssl req -new -key ic2_key.pem -nodes -subj &quot;/CN=TestIntermediate2/O=RepChain&quot; -out ic2_csr.pem</code></li>\n<li><code class=\"language-text\">openssl x509 -req -extfile ca_v3.ext -days 365 -set_serial 02 -in ic2_csr.pem -CA root_cert.pem -CAkey root_key.pem -out ic2_cert.pem</code></li>\n</ol>\n</li>\n<li>\n<p>生成Client证书CC: </p>\n<ol>\n<li><code class=\"language-text\">openssl genrsa -out cc_key.pem 2048</code></li>\n<li><code class=\"language-text\">openssl req -new -key cc_key.pem -nodes -subj &quot;/CN=TestClient/O=RepChain&quot; -out cc_csr.pem</code></li>\n<li><code class=\"language-text\">openssl x509 -req -days 365 -set_serial 01 -in cc_csr.pem -CA ic1_cert.pem -CAkey ic1_key.pem -out cc_cert.pem</code></li>\n<li><code class=\"language-text\">openssl pkcs12 -export -in cc_cert.pem -inkey cc_key.pem -out cc.p12</code></li>\n</ol>\n</li>\n<li>\n<p>生成Server证书SC: </p>\n<ol>\n<li><code class=\"language-text\">openssl genrsa -out sc_key.pem 2048</code></li>\n<li><code class=\"language-text\">openssl req -new -key sc_key.pem -nodes -subj &quot;/CN=localhost/O=RepChain&quot; -out sc_csr.pem</code></li>\n<li><code class=\"language-text\">echo subjectAltName=DNS:localhost &gt; end_v3.ext</code></li>\n<li><code class=\"language-text\">openssl x509 -req -extfile end_v3.ext -days 365 -set_serial 01 -in sc_csr.pem -CA ic2_cert.pem -CAkey ic2_key.pem -out sc_cert.pem</code></li>\n</ol>\n</li>\n</ul>\n<h2>HTTPS服务端</h2>\n<p>使用NodeJS自带的HTTPS库创建HTTPS服务:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> https <span class=\"token keyword\">from</span> <span class=\"token string\">\"https\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">...</span><span class=\"token operator\">...</span>\n\n<span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    cert<span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>cryptoMaterialDir<span class=\"token punctuation\">,</span> <span class=\"token string\">\"sc_cert.pem\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 服务端证书</span>\n    key<span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>cryptoMaterialDir<span class=\"token punctuation\">,</span> <span class=\"token string\">\"sc_key.pem\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 服务端证书对应私钥</span>\n    requestCert<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 要求客户端提供客户端证书</span>\n    rejectUnauthorized<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 客户端证书无效时也不拒绝连接</span>\n    ca<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>cryptoMaterialDir<span class=\"token punctuation\">,</span> <span class=\"token string\">\"root_cert.pem\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>cryptoMaterialDir<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ic1_cert.pem\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 用于验证客户端证书的CA证书(自动构建证书链)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">...</span><span class=\"token operator\">...</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token comment\">// 可以获取到客户端证书信息</span>\n<span class=\"token keyword\">const</span> clientCert <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">getPeerCertificate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">...</span><span class=\"token operator\">...</span><span class=\"token punctuation\">.</span>\n\nhttps<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> app<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">8888</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"clientError\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ConnectionError:\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>开启服务端：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">install</span>\n<span class=\"token function\">yarn</span> start:server</code></pre></div>\n<h2>客户端</h2>\n<p>使用浏览器和NodeJS程序分别作为客户端来进行连接验证。</p>\n<h3>浏览器</h3>\n<p>使用Chrome浏览器作为客户端</p>\n<ul>\n<li>在浏览器地址栏输入<a href=\"https://localhost:8888\">https://localhost:8888</a> 此时页面显示连接不安全，无法验证服务端证书。</li>\n<li>导入前面生成的Root CA证书root_cert.pem，以及签发服务端证书的Intermediate CA2证书ic2_cert.pem。进入浏览器菜单进行操作：设置->高级->证书管理。</li>\n<li>导入成功后，在浏览器地址栏输入<a href=\"https://localhost:8888\">https://localhost:8888</a> 此时已能验证服务端证书，页面信息提示需要导入客户端证书。</li>\n<li>导入前面生成的Client证书cc.p12，该证书文件包含了客户端的私钥和X.509证书。</li>\n<li>导入成功后，在浏览器地址栏输入<a href=\"https://localhost:8888\">https://localhost:8888</a> 此时弹出选择框，选择使用的客户端证书，然后页面信息显示通过证书身份验证，并能返回客户端证书详细信息。</li>\n</ul>\n<h3>NodeJS客户端</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> https <span class=\"token keyword\">from</span> <span class=\"token string\">\"https\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">...</span><span class=\"token operator\">...</span>\n\n<span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    hostname<span class=\"token operator\">:</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span>\n    port<span class=\"token operator\">:</span> <span class=\"token string\">\"8888\"</span><span class=\"token punctuation\">,</span>\n    method<span class=\"token operator\">:</span> <span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span>\n    pfx<span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>cryptoMaterialDir<span class=\"token punctuation\">,</span> <span class=\"token string\">\"cc.p12\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 客户端证书(包含私钥)</span>\n    ca<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>cryptoMaterialDir<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ic2_cert.pem\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>cryptoMaterialDir<span class=\"token punctuation\">,</span> <span class=\"token string\">\"root_cert.pem\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 用于验证服务端证书的CA证书(自动构建证书链)</span>\n    agent<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> req <span class=\"token operator\">=</span> https<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">...</span><span class=\"token operator\">...</span></code></pre></div>\n<p>运行客户端程序</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">yarn start<span class=\"token operator\">:</span>client</code></pre></div>\n<p>返回信息显示连接成功并通过身份验证。</p>\n<h2>总结</h2>\n<p>双向身份验证的HTTPS/TLS连接的建立，需要客户端与服务端能够验证对方的数字证书，因此各自需要能够验证对方身份证书的证书路径。</p>\n<p>基于椭圆曲线加密算法ECC中某些曲线(如secp256k1)的公钥证书在本试验环境中无法建立HTTPS/TLS连接，具体原因未知。</p>\n<p>在本试验环境下，客户端与服务端可以成功建立基于双向身份验证的HTTPS/TSL连接，并且服务端处理逻辑可以获取到客户端的证书信息。</p>","frontmatter":{"title":"双向身份验证HTTPS/TLS连接试验","date":"2020/03/13","description":"试验如何在客户端与服务端之间建立需双向身份验证的HTTPS/TLS连接","tags":["实验","tls","加密","公钥加密"]},"fields":{"readingTime":{"text":"2 min read"}}}},"pageContext":{"slug":"/tls-mutual-authentication/","previous":{"fields":{"slug":"/tls-with-various-publickey-algorithms/"},"frontmatter":{"title":"不同公钥算法所生成证书建立TLS连接时的表现"}},"next":{"fields":{"slug":"/memory-alignment/"},"frontmatter":{"title":"笔记： 对数据结构内存对齐的一点总结"}}}}}